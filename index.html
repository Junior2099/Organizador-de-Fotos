<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" sizes="32x32" href="https://img.icons8.com/?size=100&id=WKY3Y9MixZVS&format=png&color=000000">
<title>Layouts A4 — 6x(9x9), 4x(9x13), 2x(13x18)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
:root{
  --page-w: 21cm;
  --page-h: 29.7cm;
  --preview-scale: 0.62;
  --slot-border: 0.5mm dashed #bbb;
  --page-margin: 1.2cm;
  --slot-gap: 0.6cm;
  --slot-w: 9cm;
  --slot-h: 9cm;
  --grid-cols: 2;
  --grid-rows: 3;
}

*{ box-sizing: border-box; }
html,body{ height:100%; }
body{
  margin: 0;
  padding: 0;
  padding-top: 50px;
  font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  color:#0f172a;
  min-height: 100vh;
}

.toolbar{
  position: fixed; 
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  background: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 0;
  border-bottom: 1px solid #e5e7eb;
  padding: 0.5rem 1rem;
  margin: 0;
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
  align-items: center;
}

.toolbar-section{
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}

.toolbar-section:not(:last-child){
  border-bottom: none;
  padding-bottom: 0;
  margin-bottom: 0;
  border-right: 1px solid #e5e7eb;
  padding-right: 0.75rem;
  margin-right: 0.75rem;
}

.toolbar-section:last-child{
  margin-bottom: 0;
  padding-bottom: 0;
}

.toolbar label{ 
  display: inline-flex; 
  align-items: center; 
  gap: 0.35rem;
  margin: 0;
  font-weight: 500;
  font-size: 0.875rem;
}

.toolbar .form-label{
  margin-bottom: 0;
  font-weight: 600;
  color: #374151;
  font-size: 0.75rem;
  white-space: nowrap;
}

.toolbar .form-select, 
.toolbar .form-control[type="file"]{ 
  min-width: 150px;
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.toolbar .btn{
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.35rem 0.65rem;
  font-size: 0.875rem;
  transition: all 0.2s;
}

.toolbar .btn:hover{
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.zoom-control{
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 180px;
}

.zoom-control input[type="range"]{
  flex: 1;
  margin: 0;
}

.zoom-control label{
  font-size: 0.875rem;
  white-space: nowrap;
  margin: 0;
}

.fit-options{
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.fit-option{
  display: flex;
  align-items: center;
  gap: 0.35rem;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.875rem;
  transition: background-color 0.2s;
}

.fit-option:hover{
  background-color: #f3f4f6;
}

.container-fluid{
  padding: 1rem;
  margin-top: 0;
}

.wrapper{ 
  display: grid; 
  place-items: center;
  padding: 0.5rem 0;
}

.frame{
  width: calc(var(--page-w) * var(--preview-scale));
  height: calc(var(--page-h) * var(--preview-scale));
  overflow: hidden;
  border-radius: 16px;
  box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 8px 16px rgba(0,0,0,0.1);
  background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
  padding: 8px;
  transition: transform 0.3s ease;
}

.frame:hover{
  transform: scale(1.01);
}

.page{
  width: var(--page-w);
  height: var(--page-h);
  background:#fff;
  transform: scale(var(--preview-scale));
  transform-origin: top left;
  position: relative;
  padding: var(--page-margin);
  display: grid;
  place-items: center;
  box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
}

.grid{
  display: grid;
  grid-template-columns: repeat(var(--grid-cols), var(--slot-w));
  grid-template-rows: repeat(var(--grid-rows), var(--slot-h));
  gap: var(--slot-gap);
  align-items: center;
  justify-items: center;
  background: transparent;
}

.slot{
  width: var(--slot-w);
  height: var(--slot-h);
  background:#fff;
  border: var(--slot-border);
  position: relative;
  overflow:hidden;
  display:grid; 
  place-items:center;
  transition: all 0.2s;
  cursor: pointer;
}

.slot:hover{
  border-color: #3b82f6;
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
}

.slot::before{
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(59, 130, 246, 0.05);
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 1;
}

.slot:hover::before{
  opacity: 1;
}

.slot img{
  width:100%; 
  height:100%; 
  display:block; 
  object-position:center center; 
  user-select:none;
  z-index: 0;
}

.slot .overlay-input{
  position:absolute; 
  inset:0; 
  opacity:0; 
  cursor:pointer;
  z-index: 2;
}

.hint{ 
  margin-top: 1rem; 
  color:#6b7280; 
  font-size:0.9rem;
  text-align: center;
  padding: 0.75rem;
  background: rgba(255,255,255,0.7);
  border-radius: 8px;
  backdrop-filter: blur(10px);
}

.btn-group-custom{
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}


.hamburger-btn{
  display: none;
  position: fixed;
  top: 0.5rem;
  left: 0.5rem;
  z-index: 1001;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 0.5rem 0.75rem;
  font-size: 1.25rem;
  color: #374151;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: all 0.2s;
}

.hamburger-btn:hover{
  background: #f3f4f6;
  transform: scale(1.05);
}

.menu-overlay{
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  z-index: 1002;
  opacity: 0;
  transition: opacity 0.3s ease;
}

.menu-overlay.active{
  display: block;
  opacity: 1;
}

.side-menu{
  position: fixed;
  top: 0;
  left: 0;
  width: 280px;
  max-width: 85vw;
  height: 100vh;
  background: #fff;
  box-shadow: 2px 0 8px rgba(0,0,0,0.15);
  z-index: 1003;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.side-menu.open{
  transform: translateX(0);
}

.side-menu-header{
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem;
  border-bottom: 1px solid #e5e7eb;
  background: #f9fafb;
}

.side-menu-header h5{
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
  color: #111827;
}

.close-menu-btn{
  background: transparent;
  border: none;
  font-size: 1.25rem;
  color: #6b7280;
  cursor: pointer;
  padding: 0.25rem;
  border-radius: 4px;
  transition: all 0.2s;
}

.close-menu-btn:hover{
  background: #e5e7eb;
  color: #111827;
}

.side-menu-content{
  padding: 1rem;
  flex: 1;
  overflow-y: auto;
}

.side-menu-content .toolbar-section{
  flex-direction: column;
  align-items: stretch;
  border-right: none;
  border-bottom: 1px solid #e5e7eb;
  padding-right: 0;
  padding-bottom: 1rem;
  margin-right: 0;
  margin-bottom: 1rem;
  gap: 0.75rem;
}

.side-menu-content .toolbar-section:last-child{
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.side-menu-content .form-label{
  font-size: 0.875rem;
  margin-bottom: 0.5rem;
}

.side-menu-content .form-select,
.side-menu-content .form-control{
  width: 100%;
}

.side-menu-content .fit-options{
  flex-direction: column;
  gap: 0.5rem;
}

.side-menu-content .fit-option{
  width: 100%;
  padding: 0.5rem;
  justify-content: flex-start;
}

.side-menu-content .zoom-control{
  width: 100%;
  min-width: auto;
  flex-direction: column;
  align-items: stretch;
  gap: 0.5rem;
}

.side-menu-content .zoom-control label{
  width: 100%;
}

.side-menu-content .btn-group-custom{
  flex-direction: column;
  width: 100%;
}

.side-menu-content .btn-group-custom .btn{
  width: 100%;
  justify-content: center;
}

@media (max-width: 768px){
  body{
    padding-top: 50px;
  }
  
  .hamburger-btn{
    display: block;
  }
  
  .toolbar{
    display: none !important;
  }
  
  body.menu-open{
    overflow: hidden;
  }
}

@media print{
  body{ 
    margin:0; 
    padding: 0;
    background:#fff; 
  }
  .toolbar, .hint, .frame, .hamburger-btn, .side-menu, .menu-overlay{ 
    display:none !important; 
  }
  .page{ 
    width:var(--page-w); 
    height:var(--page-h); 
    transform:none !important; 
    padding:0; 
  }
  @page{ 
    size:A4; 
    margin:0; 
  }
}
</style>
</head>
<body>
  <button id="hamburgerBtn" class="hamburger-btn" aria-label="Menu">
    <i class="bi bi-list"></i>
  </button>

  <div id="menuOverlay" class="menu-overlay"></div>

  <div id="sideMenu" class="side-menu">
    <div class="side-menu-header">
      <h5>Menu</h5>
      <button id="closeMenuBtn" class="close-menu-btn" aria-label="Fechar menu">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="side-menu-content">
    </div>
  </div>

  <div class="toolbar">
    <div class="toolbar-section">
      <label class="form-label">
        <i class="bi bi-grid-3x3-gap"></i> Layout
      </label>
      <select id="layout" class="form-select">
        <option value="sixSquare">6 x 9 × 9 cm (2×3)</option>
        <option value="four9x13">4 x 9 × 13 cm (2×2)</option>
        <option value="two13x18">2 x 13 × 18 cm (1×2, paisagem)</option>
      </select>

      <label class="form-label">
        <i class="bi bi-images"></i> Imagens
      </label>
      <input id="fileInput" type="file" accept="image/*" multiple class="form-control" />
    </div>

    <div class="toolbar-section">
      <label class="form-label">
        <i class="bi bi-arrows-angle-contract"></i> Ajuste
      </label>
      <div class="fit-options">
        <label class="fit-option">
          <input type="radio" name="fit" value="cover" checked />
          <i class="bi bi-arrows-fullscreen"></i>
          <span>Preencher</span>
        </label>
        <label class="fit-option">
          <input type="radio" name="fit" value="contain" />
          <i class="bi bi-arrows-angle-expand"></i>
          <span>Ajustar</span>
        </label>
        <label class="fit-option">
          <input type="radio" name="fit" value="fill" />
          <i class="bi bi-arrows-move"></i>
          <span>Esticar</span>
        </label>
      </div>

      <label class="d-flex align-items-center gap-2">
        <input type="checkbox" id="toggleBorders" checked class="form-check-input" />
        <i class="bi bi-border"></i>
        <span>Bordas</span>
      </label>
    </div>

    <div class="toolbar-section">
      <div class="zoom-control">
        <label class="d-flex align-items-center gap-2 mb-0">
          <i class="bi bi-zoom-in"></i>
          <span>Zoom:</span>
        </label>
        <input id="zoom" type="range" min="0.35" max="1" step="0.01" value="0.62" class="form-range" />
        <span id="zoomVal" class="badge bg-primary">62%</span>
      </div>
    </div>

    <div class="toolbar-section">
      <div class="btn-group-custom">
        <button id="clearBtn" class="btn btn-outline-danger">
          <i class="bi bi-trash"></i>
          Limpar
        </button>
        <button id="savePngBtn" class="btn btn-primary">
          <i class="bi bi-file-image"></i>
          PNG
        </button>
        <button id="savePdfBtn" class="btn btn-danger">
          <i class="bi bi-file-pdf"></i>
          PDF
        </button>
      </div>
    </div>
  </div>

  <div class="container-fluid">

    <div class="wrapper">
      <div class="frame">
        <div id="page" class="page">
          <div id="grid" class="grid"></div>
        </div>
      </div>
    </div>

    <div class="hint">
      <i class="bi bi-info-circle"></i>
      Ajuste o layout e as margens acima se quiser um espaçamento diferente.
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
const root = document.documentElement;
const gridEl = document.getElementById('grid');
const fileInput = document.getElementById('fileInput');
const fitInputs = document.querySelectorAll('input[name="fit"]');
const toggleBorders = document.getElementById('toggleBorders');
const clearBtn = document.getElementById('clearBtn');
const savePngBtn = document.getElementById('savePngBtn');
const savePdfBtn = document.getElementById('savePdfBtn');
const zoomRange = document.getElementById('zoom');
const zoomVal = document.getElementById('zoomVal');
const layoutSelect = document.getElementById('layout');

let currentFitMode = 'cover';
let slots = [];

const PX_PER_CM = 300 / 2.54;
const PAGE_W_CM = 21;
const PAGE_H_CM = 29.7;

const LAYOUTS = {
  sixSquare:  { cols: 2, rows: 3, slotW: 9.0, slotH: 9.0, gap: 0.6, count: 6 },
  four9x13:   { cols: 2, rows: 2, slotW: 9.0, slotH: 13.0, gap: 0.6, count: 4 },
  two13x18:   { cols: 1, rows: 2, slotW: 18.0, slotH: 13.0, gap: 0.6, count: 2 }
};

function setCSSVar(name, value){ root.style.setProperty(name, value); }
function getComputedCm(varName){
  const v = getComputedStyle(root).getPropertyValue(varName).trim();
  return parseFloat(v) || 0;
}
function cmToPx(cm){ return Math.round(cm * PX_PER_CM); }

function buildSlots(count){
  gridEl.innerHTML = '';
  for (let i=0;i<count;i++){
    const slot = document.createElement('div');
    slot.className = 'slot';
    const overlay = document.createElement('input');
    overlay.type = 'file'; 
    overlay.accept = 'image/*'; 
    overlay.className = 'overlay-input';
    overlay.addEventListener('change', async () => {
      const file = overlay.files[0];
      if (file) await placeImageInSlot(file, slot);
      overlay.value = '';
    });
    slot.appendChild(overlay);
    gridEl.appendChild(slot);
  }
  slots = Array.from(gridEl.querySelectorAll('.slot'));
}

function applyLayout(key, keepImages = true){
  const cfg = LAYOUTS[key];
  if (!cfg) return;

  const srcs = keepImages ? slots.map(s => s.querySelector('img')?.src || null) : [];

  setCSSVar('--grid-cols', cfg.cols);
  setCSSVar('--grid-rows', cfg.rows);
  setCSSVar('--slot-w', cfg.slotW + 'cm');
  setCSSVar('--slot-h', cfg.slotH + 'cm');
  setCSSVar('--slot-gap', cfg.gap + 'cm');

  buildSlots(cfg.count);

  if (keepImages && srcs.length){
    srcs.slice(0, slots.length).forEach((src, idx) => {
      if (src) placeSrcInSlot(src, slots[idx]);
    });
  }
}

function setBorders(visible){
  setCSSVar('--slot-border', visible ? '0.5mm dashed #bbb' : '0px solid transparent');
}

function applyFitStyles(img, mode){
  img.style.objectFit = mode;
  img.style.objectPosition = 'center';
}


async function fileToOrientedDataUrl(file){
  if ('createImageBitmap' in window){
    try {
      const bmp = await createImageBitmap(file, { imageOrientation: 'from-image' });
      const c = document.createElement('canvas');
      c.width = bmp.width; 
      c.height = bmp.height;
      const ctx = c.getContext('2d');
      ctx.drawImage(bmp, 0, 0);
      if (bmp.close) try{ bmp.close(); }catch(e){}
      return await new Promise(resolve => 
        c.toBlob(b => resolve(URL.createObjectURL(b)), 'image/png')
      );
    } catch(e){
    }
  }
  return URL.createObjectURL(file);
}


function placeSrcInSlot(src, slot){
  let img = slot.querySelector('img');
  if (!img){
    img = new Image();
    img.alt = '';
    img.decoding = 'async';
    img.loading = 'eager';
    slot.appendChild(img);
  }
  img.src = src;
  applyFitStyles(img, currentFitMode);
}


async function placeImageInSlot(file, slot){
  if (!file) return;
  const url = await fileToOrientedDataUrl(file);
  placeSrcInSlot(url, slot);
}


fileInput.addEventListener('change', async () => {
  const files = Array.from(fileInput.files).slice(0, slots.length);
  for (let i=0;i<files.length;i++){
    const slot = slots[i];
    if (slot) await placeImageInSlot(files[i], slot);
  }
});

fitInputs.forEach(r => r.addEventListener('change', () => {
  currentFitMode = document.querySelector('input[name="fit"]:checked')?.value || 'cover';
  slots.forEach(s => { 
    const img = s.querySelector('img'); 
    if (img) applyFitStyles(img, currentFitMode); 
  });
}));

toggleBorders.addEventListener('change', () => setBorders(toggleBorders.checked));


clearBtn.addEventListener('click', () => {
  slots.forEach(s => s.querySelector('img')?.remove());
  fileInput.value = '';
});


function updateZoom(v){
  root.style.setProperty('--preview-scale', String(v));
  const percent = Math.round(v * 100);
  zoomVal.textContent = percent + '%';
  zoomVal.className = 'badge ' + (percent < 50 ? 'bg-secondary' : percent < 75 ? 'bg-info' : 'bg-primary');
}
zoomRange.addEventListener('input', (e) => updateZoom(e.target.value));

async function ensureImagesDecoded(imgs){
  const decs = imgs.map(img => {
    if (!img) return Promise.resolve();
    return img.decode ? img.decode().catch(()=>{}) : Promise.resolve();
  });
  await Promise.all(decs);
}

function currentLayoutConfig(){ 
  return LAYOUTS[layoutSelect.value]; 
}

async function renderToCanvas(){

  const pageWpx = cmToPx(PAGE_W_CM);
  const pageHpx = cmToPx(PAGE_H_CM);
  const canvas = document.createElement('canvas');
  canvas.width = pageWpx; canvas.height = pageHpx;
  const ctx = canvas.getContext('2d');

  ctx.fillStyle = '#ffffff';
  ctx.fillRect(0,0,canvas.width,canvas.height);

  const cfg = currentLayoutConfig();
  const slotWpx = cmToPx(cfg.slotW);
  const slotHpx = cmToPx(cfg.slotH);
  const gapPx = cmToPx(cfg.gap);

  const pageMarginCm = getComputedCm('--page-margin') || 1.2;
  const pageMarginPx = cmToPx(pageMarginCm);

  const innerW = pageWpx - 2 * pageMarginPx;
  const innerH = pageHpx - 2 * pageMarginPx;

  const totalW = cfg.cols * slotWpx + (cfg.cols - 1) * gapPx;
  const totalH = cfg.rows * slotHpx + (cfg.rows - 1) * gapPx;

  const startX = Math.round(pageMarginPx + Math.max(0, (innerW - totalW) / 2));
  const startY = Math.round(pageMarginPx + Math.max(0, (innerH - totalH) / 2));

  const imgs = slots.map(s => s.querySelector('img') || null);
  await ensureImagesDecoded(imgs);

  for (let r = 0, idx = 0; r < cfg.rows; r++){
    for (let c = 0; c < cfg.cols; c++, idx++){
      const img = imgs[idx];
      const dx = startX + c * (slotWpx + gapPx);
      const dy = startY + r * (slotHpx + gapPx);
      const dw = slotWpx;
      const dh = slotHpx;

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(dx, dy, dw, dh);

      if (!img) continue;

      const sw = img.naturalWidth || img.width;
      const sh = img.naturalHeight || img.height;
      if (!sw || !sh) continue;

      if (currentFitMode === 'fill'){
        ctx.drawImage(img, dx, dy, dw, dh);
      } else if (currentFitMode === 'contain'){
        const scale = Math.min(dw / sw, dh / sh);
        const drawW = Math.round(sw * scale);
        const drawH = Math.round(sh * scale);
        const sx = Math.round(dx + (dw - drawW) / 2);
        const sy = Math.round(dy + (dh - drawH) / 2);
        ctx.drawImage(img, 0, 0, sw, sh, sx, sy, drawW, drawH);
      } else {
        const scale = Math.max(dw / sw, dh / sh);
        const sW = Math.round(dw / scale);
        const sH = Math.round(dh / scale);
        const sX = Math.round(Math.max(0, (sw - sW) / 2));
        const sY = Math.round(Math.max(0, (sh - sH) / 2));
        ctx.drawImage(img, sX, sY, sW, sH, dx, dy, dw, dh);
      }
    }
  }

  return canvas;
}

function downloadBlob(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

savePngBtn.addEventListener('click', async () => {
  const originalText = savePngBtn.innerHTML;
  try {
    savePngBtn.disabled = true;
    savePngBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Gerando...';
    const canvas = await renderToCanvas();
    canvas.toBlob(blob => {
      if (!blob) {
        savePngBtn.disabled = false;
        savePngBtn.innerHTML = originalText;
        return;
      }
      downloadBlob(blob, `pagina-a4-${layoutSelect.value}.png`);
      savePngBtn.disabled = false;
      savePngBtn.innerHTML = originalText;
    }, 'image/png', 1.0);
  } catch (e){ 
    console.error(e); 
    alert('Erro ao gerar PNG: ' + e.message);
    savePngBtn.disabled = false;
    savePngBtn.innerHTML = originalText;
  }
});

savePdfBtn.addEventListener('click', async () => {
  const originalText = savePdfBtn.innerHTML;
  try {
    savePdfBtn.disabled = true;
    savePdfBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Gerando...';
    const canvas = await renderToCanvas();
    const dataUrl = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
    doc.addImage(dataUrl, 'PNG', 0, 0, 210, 297);
    doc.save(`pagina-a4-${layoutSelect.value}.pdf`);
    savePdfBtn.disabled = false;
    savePdfBtn.innerHTML = originalText;
  } catch (e){ 
    console.error(e); 
    alert('Erro ao gerar PDF: ' + e.message);
    savePdfBtn.disabled = false;
    savePdfBtn.innerHTML = originalText;
  }
});


const hamburgerBtn = document.getElementById('hamburgerBtn');
const closeMenuBtn = document.getElementById('closeMenuBtn');
const sideMenu = document.getElementById('sideMenu');
const menuOverlay = document.getElementById('menuOverlay');
const sideMenuContent = document.querySelector('.side-menu-content');
const toolbar = document.querySelector('.toolbar');

function copyToolbarToSideMenu(){
  if (!toolbar || !sideMenuContent) return;
  
  const sections = toolbar.querySelectorAll('.toolbar-section');
  sideMenuContent.innerHTML = '';
  
  sections.forEach(section => {
    const cloned = section.cloneNode(true);
    cloned.querySelectorAll('[id]').forEach(el => {
      el.removeAttribute('id');
    });
    sideMenuContent.appendChild(cloned);
  });
  
  attachSideMenuListeners();
}

function attachSideMenuListeners(){
  if (!sideMenuContent) return;
  
  const sideLayoutSelect = sideMenuContent.querySelector('.toolbar-section:first-child select');
  if (sideLayoutSelect && layoutSelect) {
    sideLayoutSelect.value = layoutSelect.value;
    sideLayoutSelect.addEventListener('change', (e) => {
      layoutSelect.value = e.target.value;
      layoutSelect.dispatchEvent(new Event('change'));
    });
  }
  
  const sideFileInput = sideMenuContent.querySelector('.toolbar-section:first-child input[type="file"]');
  if (sideFileInput && fileInput) {
    sideFileInput.addEventListener('change', async (e) => {
      const dt = new DataTransfer();
      Array.from(e.target.files).forEach(file => dt.items.add(file));
      fileInput.files = dt.files;
      fileInput.dispatchEvent(new Event('change'));
    });
  }
  
  const sideFitInputs = sideMenuContent.querySelectorAll('input[name="fit"]');
  const checkedFit = document.querySelector('input[name="fit"]:checked');
  sideFitInputs.forEach(input => {
    if (checkedFit && input.value === checkedFit.value) {
      input.checked = true;
    }
    input.addEventListener('change', (e) => {
      const mainInput = document.querySelector(`input[name="fit"][value="${e.target.value}"]`);
      if (mainInput) {
        mainInput.checked = true;
        mainInput.dispatchEvent(new Event('change'));
      }
    });
  });
  
  const sideToggleBorders = sideMenuContent.querySelector('.toolbar-section:nth-child(2) input[type="checkbox"]');
  if (sideToggleBorders && toggleBorders) {
    sideToggleBorders.checked = toggleBorders.checked;
    sideToggleBorders.addEventListener('change', (e) => {
      toggleBorders.checked = e.target.checked;
      toggleBorders.dispatchEvent(new Event('change'));
    });
  }
  
  const sideZoom = sideMenuContent.querySelector('.toolbar-section:nth-child(3) input[type="range"]');
  const sideZoomVal = sideMenuContent.querySelector('.toolbar-section:nth-child(3) .badge');
  if (sideZoom && zoomRange) {
    sideZoom.value = zoomRange.value;
    if (sideZoomVal) sideZoomVal.textContent = zoomVal.textContent;
    sideZoom.addEventListener('input', (e) => {
      zoomRange.value = e.target.value;
      zoomRange.dispatchEvent(new Event('input'));
      if (sideZoomVal) sideZoomVal.textContent = zoomVal.textContent;
    });
  }
  
  const sideButtons = sideMenuContent.querySelectorAll('.toolbar-section:last-child .btn');
  if (sideButtons.length >= 3) {
    sideButtons[0].addEventListener('click', () => clearBtn.click());
    sideButtons[1].addEventListener('click', () => savePngBtn.click());
    sideButtons[2].addEventListener('click', () => savePdfBtn.click());
  }
}

function openSideMenu(){
  sideMenu.classList.add('open');
  menuOverlay.classList.add('active');
  document.body.classList.add('menu-open');
}

function closeSideMenu(){
  sideMenu.classList.remove('open');
  menuOverlay.classList.remove('active');
  document.body.classList.remove('menu-open');
}

if (hamburgerBtn) {
  hamburgerBtn.addEventListener('click', () => {
    copyToolbarToSideMenu();
    openSideMenu();
  });
}

if (closeMenuBtn) {
  closeMenuBtn.addEventListener('click', closeSideMenu);
}

if (menuOverlay) {
  menuOverlay.addEventListener('click', closeSideMenu);
}

document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && sideMenu.classList.contains('open')) {
    closeSideMenu();
  }
});

function adjustBodyPadding(){
  if (window.innerWidth <= 768) {
    document.body.style.paddingTop = '50px';
    return;
  }
  
  if (toolbar) {
    const toolbarHeight = toolbar.offsetHeight;
    document.body.style.paddingTop = (toolbarHeight + 4) + 'px';
  }
}

function init(){
  setBorders(true);
  updateZoom(zoomRange.value);
  applyLayout(layoutSelect.value, false);
  adjustBodyPadding();
}

layoutSelect.addEventListener('change', () => applyLayout(layoutSelect.value, true));

window.addEventListener('resize', () => {
  adjustBodyPadding();
  if (window.innerWidth > 768 && sideMenu.classList.contains('open')) {
    closeSideMenu();
  }
});

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', adjustBodyPadding);
} else {
  adjustBodyPadding();
}

init();
</script>
</body>
</html>
